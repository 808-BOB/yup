#!/usr/bin/env node

const twilio = require('twilio');
const fs = require('fs');
const path = require('path');

async function setupTwilioVerify() {
  console.log('üîß Setting up Twilio Verify Service...\n');

  // Check for required environment variables
  const accountSid = process.env.TWILIO_ACCOUNT_SID;
  const authToken = process.env.TWILIO_AUTH_TOKEN;

  if (!accountSid || !authToken) {
    console.error('‚ùå Missing required Twilio credentials!');
    console.log('Please set these environment variables:');
    console.log('- TWILIO_ACCOUNT_SID');
    console.log('- TWILIO_AUTH_TOKEN');
    console.log('\nYou can find these in your Twilio Console: https://console.twilio.com/');
    process.exit(1);
  }

  try {
    const client = twilio(accountSid, authToken);

    // Create a new Verify service
    console.log('Creating Verify service...');
    const service = await client.verify.v2.services.create({
      friendlyName: 'Yup RSVP Phone Verification',
      codeLength: 6,
      lookupEnabled: false,
      dtmfInputRequired: false
    });

    console.log('‚úÖ Verify service created successfully!');
    console.log(`Service SID: ${service.sid}`);
    console.log(`Service Name: ${service.friendlyName}`);

    // Create .env.local file for the web app
    const envPath = path.join(__dirname, 'apps', 'web', '.env.local');
    const envContent = `# Twilio Configuration - Auto-generated by setup-twilio-verify.js
TWILIO_ACCOUNT_SID=${accountSid}
TWILIO_AUTH_TOKEN=${authToken}
TWILIO_VERIFY_SERVICE_SID=${service.sid}

# App Configuration
NEXT_PUBLIC_SITE_URL=http://localhost:3000
APP_URL=http://localhost:3000

# Add your other environment variables below:
# NEXT_PUBLIC_SUPABASE_URL=your_supabase_url_here
# NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key_here
# SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key_here
`;

    fs.writeFileSync(envPath, envContent);
    console.log(`‚úÖ Environment file created: ${envPath}`);

    console.log('\nüéâ Setup complete!');
    console.log('\nYour Twilio Verify service is ready. Next steps:');
    console.log('1. Add your Supabase credentials to apps/web/.env.local');
    console.log('2. Restart your development server (pnpm dev)');
    console.log('3. Test phone verification on your app');

  } catch (error) {
    console.error('‚ùå Error setting up Twilio Verify:', error.message);
    if (error.code) {
      console.error(`Error code: ${error.code}`);
    }
    process.exit(1);
  }
}

setupTwilioVerify(); 